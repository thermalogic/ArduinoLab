# 智能小车4- L298N控制智能小车直流电机测速


## 编码器测速模块

可以用于测速的模块很多，比如加速度计、激光、超声波、编码器等等。

由于我们对小车速度的测量精度要求不高，因此我们可以借助小车套件里面的码盘配上测速模块对其速度进行测量。  

准备材料

测速模块：  网上的测速模块有很多种外观，但是其工作原理类似，下面列出来了几种常见的测速模块，这些测速模块接线类似。  

![](img/speed/speed_module.jpg)


驱动模块安装时需要注意，不能影响轮子的正常工作，不能触碰到轮轴上的码盘。 

编码器上有三个引脚分别是“VCC”,“GND”,“OUT”。

左右两边两个测速模块的

* VCC引脚接电源或开发板的“5V”或“3.3V”引脚

* “GND”接电源或开发板的“GND”引脚，

* 左边测速模块“OUT”接开发板的“3”引脚，

* 右边测速模块“OUT”接开发板的“2”引脚。

引脚接错的话可以再随后调试过程中换过来，也可以在代码里更改。  


 最终接线图如下

 ![](img/speed/speed_module_wired.jpg)


## 测速模块讲解
测速模块的工作原理比较简单，如下图所示，
  
  在于电机同轴的码盘上有很多开孔（光栅），编码器相当于光敏元件。码盘随着小车轮子的运动转动时，码盘（光栅）会不断遮挡光敏元件发出的光波，这时候编码器就会根据光栅的遮挡不断的产生方波信号，方波信号会从“OUT”引脚输出，我们只需不断检测“OUT”引脚的输出，根据方波信号的周期简介计算出小车运行的速度。小车上使用的码盘（光栅）精度不高，在某些高精度的编码器上光栅会更加密集，测量效果会更好。 

  ![](img/speed/speed_theory.jpg) 

  由于要**不断检测编码器输出端**的输出，因此我们需要借助Arduino的**外部中断**来读取编码器的输出。
  
  Arduino开发板外部中断对应的引脚如下：

  ![](img/speed/arduino_inter.jpg)

  由表中可以知道在此我们使用的Arduino UNO只有“2”，“3”引脚可以触发外部中断，因此在接线的时候我们便将左右两边的输出“OUT”引脚分别接在“2”“3”引脚上。 
  
  在程序初始化阶段中调用函数`attachInterrupt(interrupt, function, mode)`可以对中断引脚初始化，其中 
  
  * interrupt： 要初始化的外部中断编号，由上表可知我们Arduino UNO只能使用外部中断0和外部中断1； 
  
  * function： 中断服务函数的名字，即当外部中断被触发时，将会自动调用这个函数； 
  
  * mode： 中断触发的方式，可选方式如下  

  ![](img/speed/arduino_inter_type.jpg)

  